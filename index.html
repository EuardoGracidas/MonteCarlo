<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Monte Carlo Simulation</title>
  <link rel="stylesheet" href="index.css">
</head>
<body>
  <h2 id = "titulo">Monte Carlo Simulation</h2>


    <section class="panel">
  <h3>Parámetros</h3>

  <div class="form-grid">
    <!-- Simulación -->
    <div class="field">
      <label for="Nphotons">Fotones</label>
      <input id="Nphotons" type="number" value="1000000" min="1" step="1">
      <small>Cantidad de fotones a simular</small>
    </div>

    <div class="field">
      <label for="NC">Capas (slabs)</label>
      <input id="NC" type="number" value="3" min="1" step="1">
      <small>Número de capas planas en Z</small>
    </div>

    <!-- Dominio -->
    <div class="field">
      <label for="Rxy">R<sub>xy</sub> (cm)</label>
      <input id="Rxy" type="number" value="0.065" step="0.0001" min="0">
      <small>Semiancho lateral del dominio (radio en X/Y)</small>
    </div>

    <!-- Tumor (centro) -->
    <div class="field">
      <label for="theight">Y del tumor (cm)</label>
      <input id="theight" type="number" value="0.15" min="0" step="any">
      <small>Profundidad (eje Z)</small>
    </div>

    <div class="field">
      <label for="tumorX">X del tumor (cm)</label>
      <input id="tumorX" type="number" value="0" step="any">
      <small>Desplazamiento lateral X</small>
    </div>

    <div class="field">
      <label for="tumorY">Z del tumor (cm)</label>
      <input id="tumorY" type="number" value="0" step="any">
      <small>Desplazamiento lateral Y</small>
    </div>

    <!-- Fuente -->
    <div class="field">
      <label for="lambda">λ (nm)</label>
      <input id="lambda" type="number" value="400" min="1" step="1">
      <small>Longitud de onda del láser</small>
    </div>

    <div class="field">
      <label for="Nit">Iterations number</label>
      <input id="Nit" type="number" value="400" min="1" step="1">
      <small>Iterations number</small>
    </div>

    <!-- Acciones / Archivo -->
    <div class="field span-2">
      <label for="fileCSV">Importar parámetros ópticos (CSV, opcional)</label>
      <input id="fileCSV" type="file" accept=".csv">
      <small>Cabecera esperada: <code>Tipo,mua,mus,g,nt,z_end</code></small>
    </div>

    <div class="actions span-2">
      <button id="init" class="btn-primary">Crear tabla</button>
    </div>
  </div>
</section>


  <table id="tabla" aria-label="Capas">
    <thead>
      <tr>
        <th>#</th><th>Type</th><th>µa</th><th>µs</th><th>g</th><th>nt</th><th>Z end or radio (cm)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <br>

  <button id="run">Simulate</button>

  <h4>Simulation</h4>
  <div id="contenedor">
    <div id="salida"></div>
    <!-- Vista 3D esquemática -->
    <div id="vista3D" style="margin-top:20px;">
    <canvas id="canvas3D" ></canvas>
    </div>
  </div>

  <div class="explanation">
  <h3>About This Simulation</h3>
  <p>
    This simulation uses a Monte Carlo–based algorithm designed to model light–tissue interactions. 
    The user must manually provide the optical properties of each tissue layer to be simulated 
    (<em>µ<sub>a</sub></em>, <em>µ<sub>s</sub></em>, <em>g</em>, and <em>n<sub>t</sub></em>), 
    as well as parameters such as tissue type, number of photons, number of layers, 
    wavelength, and, if applicable, the tumor center and its distance from the surface layer.
  </p>

  <h4>¡Important Considerations!</h4>
  <ul>
    <li>
      Although there is no limit to the number of layers, the graphical representation may visually 
      “cut off” some layers. This does not affect the numerical results, it is only a 
      display limitation.
    </li>
    <li>
      In the 3D simulation, the laser vertical position is fixed at 3 cm. 
      Therefore, if the simulation requires a greater vertical distance, the laser may appear 
      within the tissue layers. Similarly, for tissue widths below 0.05 cm, the laser may 
      fully cover the tissue.
    </li>
    <li>
      <strong>This simulation is designed for desktop or laptop computers</strong>. Other devices 
      (such as mobile phones or tablets) may not be able to render the 3D model correctly 
      or may fail to display the graphics properly.
    </li>
    <li>
      The number of photons is automatically set to 1×10⁶ by default. 
      <strong>Higher photon counts require more processing time and may cause the simulation to crash.</strong> 
      However, the program should handle up to approximately 1×10⁸ photons without issues. Have in mind that lager photon values "stop" the simulation from working, this is normal as the page needs to complete the calculations before performing any other operation so the user has to wait until the simulation ends before performing other simulation or introducing other values.
    </li>
    <li>
      While it is technically possible to define more than one tumor, <strong>the simulation 
      is not optimized for multiple tumors</strong>. As a result, numerical accuracy may be reduced 
      in such cases.
    </li>
    <li>
      The value of <em>λ</em> (wavelength) only determines the laser’s display color 
      and does not affect the numerical calculations. Users should verify independently 
      that the selected optical properties correspond to the chosen wavelength.
    </li>
  </ul>
</div>


  <div class="mc-summary">
    <div class="text">
        <h2>Monte Carlo Simulation in Light–Tissue Interactions</h2>

        <h3>General Introduction</h3>
        <p>
            The simulation implemented in this project is based on the principles of the <strong>radiative transport theory</strong>,
            which describes the propagation of light in turbid or highly scattering media, such as biological tissues.
            In these media, light undergoes multiple simultaneous optical phenomena: <em>absorption</em>,
            <em>scattering</em>, <em>reflection</em>, and <em>refraction</em>, as shown in Figure 1.
        </p>

        <p>
            Human tissues are not transparent media; they are optically complex systems composed of cells, organelles, and
            structures that deflect light in unpredictable directions. Therefore, analytical solutions to the transport equations
            are difficult to obtain. Instead, <strong>Monte Carlo simulation methods</strong> are used to reproduce
            light behavior through a probabilistic and stochastic approach.
        </p>

        <h3>Optical Parameters of Tissue</h3>
        <p>
            Each layer of the tissue model is characterized by four fundamental parameters:
        </p>
        <ul>
            <li><strong>µ<sub>a</sub>:</strong> absorption coefficient, which measures the probability that a photon is absorbed per unit length.</li>
            <li><strong>µ<sub>s</sub>:</strong> scattering coefficient, which represents the probability of a change in direction per unit length.</li>
            <li><strong>g:</strong> anisotropy factor, indicating the degree of directionality of the scattering.</li>
            <li><strong>n<sub>t</sub>:</strong> refractive index, which determines how the speed of light changes in each medium.</li>
        </ul>

        <p>
            From these parameters, the <strong>albedo</strong> is defined as µ<sub>s</sub> / (µ<sub>a</sub> + µ<sub>s</sub>),
            which expresses the fraction of energy that is scattered versus absorbed, as illustrated in Figure 2.
        </p>

        <h3>Description of the Monte Carlo Algorithm</h3>
        <p>
            The Monte Carlo algorithm divides a photon’s trajectory into a sequence of propagation and scattering events, similar to what is shown in Figure 3.
            At each step:
        </p>
        <p>
            A random number is generated to compute the mean free path (<em>step size</em>) according to the distribution
            <code>s = -ln(ξ)/(µ<sub>a</sub> + µ<sub>s</sub>)</code>, where ξ is a uniformly distributed random variable between 0 and 1.
            The photon advances that distance, loses a fraction of its energy proportional to µ<sub>a</sub>, and changes direction
            according to the Henyey–Greenstein phase function, which approximates anisotropic scattering in biological tissues.
        </p>

        <p>
            This process continues until the photon’s weight falls below a threshold, at which point the so-called “Russian roulette”
            is applied to decide whether the photon terminates or survives with adjusted weight. The procedure is repeated for millions of photons,
            accumulating the energy deposited in each region of the tissue.
        </p>
        <p>
            The entire process is summarized in the illustration of Figure 4.
        </p>

        <h3>Implementation in the Code</h3>
        <p>
            In the presented code, the model allows you to freely define the number of layers, their optical properties, and the dimensions
            in centimeters. You can include <strong>planar layers (slabs)</strong> and one or more <strong>spherical layers</strong> to simulate
            tumors or internal structures.
        </p>

        <p>
            The simulation records the energy absorbed in each layer and computes the total fraction of lost energy.
            The results are presented numerically and through a schematic, to-scale representation, where the layers appear
            colored according to their type (for example, muscle, fat, skin, or tumor).
        </p>

        <h3>Physical Interpretation</h3>
        <p>
            According to optical transport theory and the models shown in the slides,
            the final distribution of absorbed energy represents the <strong>light fluence</strong>
            (<em>Φ</em> in W/cm²) within the tissue, and the local accumulation is interpreted as the <strong>absorbed power density</strong>
            (<em>Q</em> in W/cm³). These quantities are key for applications such as
            <em>photodynamic therapy</em> and <em>optical dosimetry</em> in the treatment of superficial tumors.
        </p>

        <h3>In Summary</h3>
        <p>
            The implemented Monte Carlo simulation is a robust and flexible numerical tool to
            reproduce light propagation in biological media. Its theoretical foundation relies on the radiative transport equation,
            and its strength lies in its easy adaptation to multilayer tissues and irregular structures
            where analytical methods are not feasible.
        </p>
    </div>

    <div class="imagenes">
        <img src="img1.png" alt="Light transport in turbid and transparent media">
        <p>Figure 1: Light transport in turbid and transparent media.</p>
        <img src="img2.png" alt="Optical parameter values in tissues">
        <p>Figure 2: Description of optical parameter values in tissues.</p>
        <img src="img3.png" alt="Representation of the transport equation in biological tissue">
        <p>Figure 3: Representation of the transport equation in biological tissue.</p>
        <img src="img4.png" alt="Flowchart of the Monte Carlo simulation">
        <p>Figure 4: Flowchart of the Monte Carlo simulation.</p>
    </div>
  </div>
  <div class="pie">
  <h3>
    Program by Eduardo Gracidas Reyes on Sunday, October 19, 2025; Contents by PhD. Juan Horacio Rodríguez Espinoza 
  </h3>
</div>


  <script src="index.js" defer></script>
</body>
</html>
